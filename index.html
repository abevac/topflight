<html>
  <head>
    <title>Topflight</title>
    <meta charset="UTF-8">
    <link href="http://fonts.googleapis.com/css?family=Lato|Montserrat" rel="stylesheet" type="text/css">
    <link href="iata.css" rel="stylesheet" type="text/css">
    <!-- <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <script type="text/javascript" src="airlines.json"></script> -->
    <script type="text/javascript" src="airports.json"></script>
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <style type="text/css">
      body {
        font: 14pt 'Montserrat';
      }
      h2 {
        font: 26pt 'Montserrat' normal;
      }
      input, label {
        font: 12pt 'Lato';
      }
      #results {
        font: 14pt 'Montserrat';
        font-weight: normal;
        color: #333;
      }
      .result {
        display: table;
        background: #DEF;
        /*border: 1px solid #333;*/
        border-radius: 8px;
        color: #333;
        text-decoration: none;
        min-width: 290px;
        width: 99%;
        height: auto;
        margin: 7px;
        padding: 5px;
        cursor: pointer;
      }
      .result:hover {
        background: #CDE;
      }
      .fare {
        font: 14pt 'Montserrat' bold;
        color: #383;
        padding: 10px;
        width: 60px;
        text-align: center;
        border-right: 1px solid gray;
        display: table-cell;
        vertical-align: middle;
      }
      .flight_details {
        padding-left: 15px;
        //TODO:FIX;
      }
      .flight_data {
        font: 14pt 'Lato';
        font-weight: normal;
        color: #333;
        padding: 6px 10px;
        font-size: 11pt;
      }
      #loading {
        position: absolute;
        top:10px;
        left:50%;
        margin-left:-50px;
        width: 100px;
        background: #FFA;
        padding: 10px;
      }
    </style>
    <script type="text/javascript">
      var AMADEUS_API_KEY = "7J4zdDj82DKOGsU8C0U1h4mGaeLmrwrE";
      var queries = {};

      $(function() {
        $("#ori, #dst").click(function(e) {
          $(this).select();
        });
        $("#ori, #dst").autocomplete({
          minLength: 2,
          source: function(request, response) {
            var iataMatch = airports.filter(
              function(airport){
                return airport.iata === request.term.toUpperCase();
              }
            );
            var cityMatches = airports.filter(
              function(airport){
                return airport.iata &&
                  airport.city.toLowerCase().indexOf(request.term.toLowerCase()) === 0;
              }
            );
            response(iataMatch.concat(cityMatches).map(function(airport) {
              return {
                label: airport.iata + " – " + airport.city + ", " + airport.name,
                value: airport.iata
              };
            }));
          },
          autoFocus: true,
          select: function( event, ui ) {
            console.log(event, ui);
            var TABKEY = 9;
            this.value = ui.item.value;

            if (event.keyCode == TABKEY) {
                //event.preventDefault();
                $(this).focus();
            }

            amadeusQuery();
            return false;
            // $(event.target).blur();
          },
          change: function (event, ui) {
            if (!ui.item) {
              $(this).val("");
            }
            //amadeusQuery();
          }
        });
        $("#dep").datepicker({
          dateFormat: "D, MM d",
          altField: "#depFmt",
          altFormat: "yy-mm-dd",
          showAnim: "slideDown",
          minDate: -1,
          maxDate: "+11M",
          onClose: function(selectedDate) {
            $("#ret").datepicker("option", "minDate", selectedDate);
          },
          onSelect: function(d, i) {
            if (d !== i.lastVal){
              amadeusQuery();
            }
          }
        });

        $("#ret").datepicker({
          dateFormat: "D, MM d",
          altField: "#retFmt",
          altFormat: "yy-mm-dd",
          showAnim: "slideDown",
          minDate: -1,
          maxDate: "+10M 2W",
          onClose: function(selectedDate) {
            $("#dep").datepicker("option", "maxDate", selectedDate);
          },
          onSelect: function(d, i) {
            if (d !== i.lastVal){
              $("#rt").prop("checked", true);
              amadeusQuery();
            }
          }
        });

        var qh = location.hash.match(
          /#search;f=(\w{3})(?:;t=(\w{3}))?;d=(\d{4})-(\d{2})-(\d{2})(?:;r=(\d{4})-(\d{2})-(\d{2}))?/
        );
        if (!qh) {
          console.error("Hash failed");
          location.hash = "";
          $("#dep").datepicker("setDate", "3w");
        } else {
          console.log("HASH SUCCESS", qh);
          $("#ori").val(qh[1]);
          $("#dst").val(qh[2]);
          var today = new Date();
          var newDep = new Date(qh[3], qh[4]-1, qh[5]);
          if (newDep < today)
            $("#dep").datepicker("setDate", "3w");
          else {
            $("#dep").datepicker("setDate", newDep);
            $("#ret").datepicker("option", "minDate", newDep);
          }
          var newRet = new Date(qh[6], qh[7]-1, qh[8]);
          if (newRet < newDep){
            newRet = "";
          } else {
            $("#rt").prop("checked", true);
          }
          $("#ret").datepicker("setDate", newRet);
          $("#dep").datepicker("option", "maxDate", newRet);
        }

        $("#ow").click(function() {
          $("#ret").datepicker("setDate", "");
          amadeusQuery();
        });

        amadeusQuery();
        // window.onhashchange = amadeusQuery;
      });

      function amadeusQuery() {
        var ori = $("#ori").val();
        var dst = $("#dst").val();
        var dep = $("#depFmt").val();
        var ret = $("#retFmt").val();
        if (!ori || !dst || !dep){
          hideLoadingUI();
          return;
        }
        location.hash = "#search;f="+ori+";t="+dst+";d="+dep+(ret?";r="+ret:"");

        var qs = {
          'apikey': AMADEUS_API_KEY,
          'origin': $('#ori').val(),
          'destination': $('#dst').val(),
          'departure_date': $('#depFmt').val(),
          'exclude_airlines': 'US'
        };

        if (return_date = $('#retFmt').val())
          qs["return_date"] = return_date;

        var queryID = new Date().getTime();
        queries[queryID] = true;
        $("#loading").show();
        $("#results").css("opacity", "0.3");
        $("#results").css("filter", "alpha(opacity=30)");
        $.getJSON(
          "https://api.sandbox.amadeus.com/v1.2/flights/low-fare-search", qs
        )
        .done(function(data) {
          var resultsDiv = $("#results");
          resultsDiv.empty();

          delete queries[queryID];
          if ($.isEmptyObject(queries)) {
            hideLoadingUI();
          }

          $.each(data.results, function(i, result){
            console.log(result);

            var resultRow = $(document.createElement('a'))
              .addClass('result')
              //.attr('href', airline.url)
              .appendTo(resultsDiv);

            resultRow.click(function(a){
              $(this).find('.extradata').toggle();
            });

            $(document.createElement('div'))
              .addClass('fare')
              .text("$"+Math.ceil(result.fare.total_price))
              .appendTo(resultRow);

            var flightDetails = $(document.createElement('table'))
              .addClass('flight_details')
              //.attr('href', airline.url)
              .appendTo(resultRow);

            appendFlightDetails(flightDetails, result.itineraries[0].outbound.flights);

            if(result.itineraries[0].inbound) {
              appendFlightDetails(flightDetails, result.itineraries[0].inbound.flights);
            }
          });
        })
        .fail(function(jqxhr, textStatus, error) {
          delete queries[queryID];
          if ($.isEmptyObject(queries)) {
            hideLoadingUI();
            $("#results").empty();
          }
        });
      }

      function hideLoadingUI() {
        $("#loading").hide();
        $("#results").css("opacity", "1");
        $("#results").css("filter", "alpha(opacity=100)");
      }

      function appendFlightDetails(container, flights) {
        var stops = flights.length-1;
        var firstFlight = flights[0];
        var lastFlight = flights[flights.length-1];

        var flightRow = $(document.createElement('tr'))
          .appendTo(container);

        var logoCell = $(document.createElement('td'))
          .appendTo(flightRow);

        $(document.createElement('div'))
            .addClass('logo')
            .addClass('_' + firstFlight.marketing_airline.toLowerCase())
            .appendTo(logoCell);

        if (stops == 0) {
          var flightData = $(document.createElement('td'))
            .addClass('flight_data')
            .html(formatTime(new Date(firstFlight.departs_at)) + " – " +
              formatTime(new Date(firstFlight.arrives_at)) + "<br />" +
              firstFlight.origin.airport + "–" + firstFlight.destination.airport
            )
            .appendTo(flightRow);

          if (firstFlight.operating_airline != firstFlight.marketing_airline) {
            flightData.append(" (operated by " + firstFlight.operating_airline + ")");
          }

          var flightSubDetail = $(document.createElement('td'))
              .addClass('flight_details')
              .addClass('extradata')
              //.attr('href', airline.url)
              .appendTo(flightData)
              .hide();

          $(document.createElement('div'))
            .text(firstFlight.marketing_airline + " " + firstFlight.flight_number)
            .appendTo(flightSubDetail);
        } else {
          var flightData = $(document.createElement('td'))
            .addClass('flight_data')
            .html(formatTime(new Date(firstFlight.departs_at)) + " – " +
              formatTime(new Date(lastFlight.arrives_at)) + "<br />" +
              firstFlight.origin.airport + "–" + lastFlight.destination.airport
              + " (" + stops + " stop" + (stops>1?"s":"") + ")")
            .appendTo(flightRow);

          var flightSubDetail = $(document.createElement('td'))
              .addClass('flight_details')
              .addClass('extradata')
              //.attr('href', airline.url)
              .appendTo(flightData)
              .hide();

          $.each(flights, function(j, flight) {
            var flightExtraData = $(document.createElement('div'))
              .text(flight.marketing_airline + " " + flight.flight_number
                + ": " + flight.origin.airport + "-" + flight.destination.airport)
              .appendTo(flightSubDetail);

            if (flight.operating_airline != flight.marketing_airline) {
                flightExtraData.append(" (operated by " + flight.operating_airline + ")");
            }
            // $(document.createElement('div'))
            //   .addClass('flight_data')
            //   .text("Fare class: " + flight.booking_info.booking_code)
            //   .appendTo(flightSubDetail);
          });

        }
      }

      function formatTime(d) {
        var hours = d.getUTCHours();
        var minutes = d.getUTCMinutes();
        var ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12;
        minutes = minutes < 10 ? '0'+minutes : minutes;
        return hours + ':' + minutes + ' ' + ampm;
      }
    </script>
  </head>
  <body>
    <h2>Topflight</h2>
    <label><input id="rt" type="radio" name="tt" value="rt">Round trip</label>
    <label><input id="ow" type="radio" name="tt" value="ow" checked>One way</label>
    <table>
      <tr>
        <td>
          <input id="ori" autocomplete="off" placeholder="Origin" value="BOS" />
        </td>
        <td>
          <input id="dst" autocomplete="off" placeholder="Destination" />
        </td>
      </tr>
      <tr>
        <td>
          <input id="dep" autocomplete="off" placeholder="Departing" />
          <input id="depFmt" type="hidden">
        </td>
        <td>
          <input id="ret" autocomplete="off" placeholder="Returning" />
          <input id="retFmt" type="hidden">
        </td>
      </tr>
    </table>
    <div id="loading">Loading...</div>
    <div id="results"></div>
  </body>
</html>